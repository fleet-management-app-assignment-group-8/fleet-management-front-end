===============================
KUBERNETES & ISTIO DEPLOYMENT GUIDE
===============================

PREREQUISITES
-------------
1. Kubernetes cluster (v1.24+)
2. Istio installed (v1.18+)
3. kubectl configured
4. Docker registry access

BUILD & PUSH IMAGE
------------------
# Build the Docker image
docker build -t your-registry/fleet-frontend:v1.0.0 .

# Push to registry
docker push your-registry/fleet-frontend:v1.0.0

# Update kustomization.yaml with your registry
# Edit k8s/kustomization.yaml and update the image section

DEPLOYMENT STEPS
----------------

1. Create namespace with Istio injection:
   kubectl apply -f k8s/namespace.yaml

2. Create secrets (IMPORTANT - Update with real values first!):
   # Generate NEXTAUTH_SECRET
   export NEXTAUTH_SECRET=$(openssl rand -base64 32)
   
   # Create secret
   kubectl create secret generic fleet-frontend-secrets \
     --from-literal=NEXTAUTH_URL=https://your-domain.com \
     --from-literal=NEXTAUTH_SECRET=$NEXTAUTH_SECRET \
     --from-literal=KEYCLOAK_ID=fleet-management-client \
     --from-literal=KEYCLOAK_SECRET=your-keycloak-secret \
     -n fleet-management

3. Update ConfigMap with your service URLs:
   # Edit k8s/configmap.yaml
   # Update service URLs to match your environment

4. Deploy using Kustomize:
   kubectl apply -k k8s/

   OR deploy individually:
   kubectl apply -f k8s/configmap.yaml
   kubectl apply -f k8s/deployment.yaml
   kubectl apply -f k8s/service.yaml
   kubectl apply -f k8s/hpa.yaml
   kubectl apply -f k8s/istio/

5. Verify deployment:
   kubectl get pods -n fleet-management
   kubectl get svc -n fleet-management
   kubectl logs -f deployment/fleet-frontend -n fleet-management

6. Check Istio injection:
   kubectl get pods -n fleet-management -o jsonpath='{.items[*].spec.containers[*].name}'
   # Should see: fleet-frontend istio-proxy

ISTIO CONFIGURATION
-------------------

1. Gateway & VirtualService:
   - Edit k8s/istio/gateway.yaml
   - Replace "fleet.example.com" with your domain
   - Add TLS certificate secret if using HTTPS

2. Create TLS secret (for HTTPS):
   kubectl create secret tls fleet-frontend-tls \
     --cert=path/to/cert.pem \
     --key=path/to/key.pem \
     -n fleet-management

3. Update ServiceEntry for external Keycloak:
   - Edit k8s/istio/serviceentry.yaml
   - Update Keycloak domain

4. Apply Istio configs:
   kubectl apply -f k8s/istio/

VERIFY ISTIO
------------
# Check virtual services
kubectl get virtualservices -n fleet-management

# Check destination rules
kubectl get destinationrules -n fleet-management

# Check gateways
kubectl get gateways -n fleet-management

# Check peer authentication
kubectl get peerauthentication -n fleet-management

# Check authorization policies
kubectl get authorizationpolicies -n fleet-management

ACCESS THE APPLICATION
----------------------
# Get Istio Ingress Gateway external IP
kubectl get svc istio-ingressgateway -n istio-system

# Access via:
# http://<EXTERNAL-IP>
# or https://your-domain.com (if DNS configured)

MONITORING
----------
# View logs
kubectl logs -f deployment/fleet-frontend -n fleet-management

# View Istio sidecar logs
kubectl logs -f deployment/fleet-frontend -c istio-proxy -n fleet-management

# Check pod status
kubectl describe pod <pod-name> -n fleet-management

# View HPA status
kubectl get hpa -n fleet-management

SCALING
-------
# Manual scaling
kubectl scale deployment fleet-frontend --replicas=5 -n fleet-management

# HPA will auto-scale based on CPU/Memory (configured in hpa.yaml)

ROLLOUT & UPDATES
-----------------
# Update image
kubectl set image deployment/fleet-frontend \
  fleet-frontend=your-registry/fleet-frontend:v1.0.1 \
  -n fleet-management

# Check rollout status
kubectl rollout status deployment/fleet-frontend -n fleet-management

# Rollback if needed
kubectl rollout undo deployment/fleet-frontend -n fleet-management

TROUBLESHOOTING
---------------
# Pod not starting
kubectl describe pod <pod-name> -n fleet-management
kubectl logs <pod-name> -n fleet-management

# Istio sidecar issues
kubectl logs <pod-name> -c istio-proxy -n fleet-management

# Check Istio configuration
istioctl analyze -n fleet-management

# Verify mTLS
istioctl authn tls-check <pod-name>.fleet-management

# Check service mesh
istioctl proxy-status

CLEANUP
-------
# Delete all resources
kubectl delete -k k8s/

# Or delete namespace (removes everything)
kubectl delete namespace fleet-management

PRODUCTION CHECKLIST
--------------------
[x] Secrets stored securely (not in Git)
[x] Resource limits configured
[x] Health checks configured
[x] HPA configured
[x] Istio mTLS enabled
[x] Authorization policies configured
[x] TLS certificate configured
[x] Monitoring/logging configured
[x] Backup strategy in place
[x] Disaster recovery plan
[x] Security scanning done
[x] Load testing completed

